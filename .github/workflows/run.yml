name: RDP + Tailscale + RustDesk + (Optional) Chrome Remote Desktop (A)

on:
  workflow_dispatch:
    inputs:
      ts_tailnet: { description: "Tailscale tailnet", required: true }
      ts_api_key: { description: "Tailscale API key", required: true }
      ts_authkey: { description: "Tailscale Auth key", required: true }
      runtime_minutes: { description: "Runtime (max 360)", default: "360" }

permissions:
  contents: read
  actions: write

defaults:
  run:
    shell: pwsh

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 370
    env:
      RDP_USER: Bullettemporary
      RDP_PASS: Bullet@12345

    steps:
      - name: Enable RDP user + firewall
        run: |
          $u=$env:RDP_USER; $p=$env:RDP_PASS
          $sec = ConvertTo-SecureString $p -AsPlainText -Force
          if (-not (Get-LocalUser -Name $u -EA SilentlyContinue)) {
            New-LocalUser -Name $u -Password $sec -AccountNeverExpires
            Add-LocalGroupMember -Group "Administrators" -Member $u
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member $u
          }
          Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name fDenyTSConnections -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      # ================== üî• G·ªòP T·ªêI ∆ØU ·ªû ƒê√ÇY üî• ==================
      - name: AUTO OPTIMIZE ‚Äì RDP + AUDIO NEVER OFF (6H SAFE)
        shell: cmd
        run: |
          powercfg -x -monitor-timeout-ac 0
          powercfg -x -disk-timeout-ac 0
          powercfg -x -standby-timeout-ac 0
          powercfg -x -hibernate-timeout-ac 0

          for /f "tokens=3" %%a in ('powercfg -l ^| find "High performance"') do powercfg -setactive %%a

          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fSingleSessionPerUser /t REG_DWORD /d 0 /f
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v IdleTimeout /t REG_DWORD /d 0 /f
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v MaxDisconnectionTime /t REG_DWORD /d 0 /f
          reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" /v MaxIdleTime /t REG_DWORD /d 0 /f
          reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" /v MaxDisconnectionTime /t REG_DWORD /d 0 /f

          sc config Audiosrv start= auto
          sc config AudioEndpointBuilder start= auto
          net start Audiosrv
          net start AudioEndpointBuilder

          reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Audio" /v DisableProtectedAudioDG /t REG_DWORD /d 1 /f
          reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" /v InactivityTimeoutSecs /t REG_DWORD /d 0 /f

          schtasks /create /sc minute /mo 1 /tn "KeepAlive" /tr "cmd /c exit" /ru SYSTEM /f

          echo OPTIMIZE DONE
      # ============================================================

      - name: Install + Up Tailscale
        run: |
          $ts="$env:ProgramFiles\Tailscale\tailscale.exe"
          if (-not (Test-Path $ts)) {
            Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi -OutFile ts.msi
            Start-Process msiexec.exe -ArgumentList "/i ts.msi /quiet /norestart" -Wait
          }
          & $ts up --authkey "${{ inputs.ts_authkey }}"

      - name: Keep alive
        run: |
          $end=(Get-Date).AddMinutes([int]"${{ inputs.runtime_minutes }}")
          while((Get-Date) -lt $end){
            Write-Host "Alive $(Get-Date)"
            Start-Sleep 60
          }
